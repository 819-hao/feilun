<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.seeease.flywheel.serve.purchase.mapper.BillPurchaseReturnMapper">
    <select id="getPage" parameterType="com.seeease.flywheel.purchase.request.PurchaseReturnListRequest"
            resultType="com.seeease.flywheel.purchase.result.PurchaseReturnListResult">
        SELECT
        bpr.id id,
        bpr.serial_no,
        bpr.purchase_return_state,
        bpr.return_price,
        bpr.created_by,
        bpr.remarks,
        bpr.created_time,
        c.customer_name,
        count( bprl.id ) number
        FROM
        bill_purchase_return bpr
        LEFT JOIN customer c ON c.id = bpr.customer_id
        LEFT JOIN bill_purchase_return_line bprl ON bprl.purchase_return_id = bpr.id
        <where>
            bpr.deleted = 0
            <if test="request.startTime != null and request.startTime != '' and request.endTime != null and request.endTime != ''">
                AND DATE_FORMAT(bpr.created_time,'%Y-%m-%d %H:%i:%s') BETWEEN #{request.startTime} AND
                #{request.endTime}
            </if>
            <if test="request.createdBy !=null and request.createdBy !=''">
                and bpr.created_by like CONCAT('%', #{request.createdBy},'%')
            </if>
            <if test="request.purchaseReturnState !=null">
                and bpr.purchase_return_state =#{request.purchaseReturnState}
            </if>
            <if test="request.customerName !=null and request.customerName !=''">
                and c.customer_name like CONCAT('%', #{request.customerName},'%')
            </if>
            <if test="request.storeId !=null">
                and bpr.store_id =#{request.storeId}
            </if>
            <if test="request.stockIdList !=null">
                <foreach collection="request.stockIdList" item="id" open="and bprl.stock_id in (" separator=","
                         close=")">
                    #{id}
                </foreach>
            </if>
            <if test="request.serialNo !=null">
                and bpr.serial_no like CONCAT(#{request.serialNo},'%')
            </if>

        </where>
        group by bpr.serial_no
        order by bpr.id desc
    </select>
</mapper>
