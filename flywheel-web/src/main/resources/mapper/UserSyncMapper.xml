<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.seeease.flywheel.web.infrastructure.mapper.UserSyncMapper">


    <resultMap id="UserResultMap" type="com.seeease.flywheel.web.entity.User">
        <id property="id" column="id" jdbcType="INTEGER"/>
        <result property="userid" column="userid" jdbcType="VARCHAR"/>
        <result property="userName" column="name" jdbcType="VARCHAR"/>
        <result property="tagName" column="tag_name" jdbcType="VARCHAR"/>
        <result property="tagShortcodes" column="shortcodes" jdbcType="VARCHAR"/>
        <collection property="roles" javaType="java.util.ArrayList" ofType="com.seeease.flywheel.web.entity.UserRole">
            <result property="roleName" column="role_name" jdbcType="VARCHAR"/>
            <result property="roleKey" column="role_key" jdbcType="VARCHAR"/>
            <result property="shopSpec" column="shop_spec" jdbcType="VARCHAR"/>
        </collection>
    </resultMap>

    <select id="selectUser" resultMap="UserResultMap">
        SELECT u.id,
        u.userid,
        u.name,
        t.tag_name,
        t.shortcodes,
        r.role_name,
        r.role_key,
        r.shop_spec
        FROM `user` u
        LEFT JOIN user_tag ut on ut.user_id = u.id
        LEFT JOIN tag t on t.id = ut.tag_id
        LEFT JOIN user_role ur on ur.user_id = u.id
        LEFT JOIN role r on ur.role_id = r.id and r.work_need = 1
        <where>
            <if test="userId !=null">
                u.userid= #{userId}
            </if>
            <choose>
                <when test="storeId!=null">
                   AND EXISTS (SELECT sm.id from store_management sm WHERE sm.tag_id = ut.tag_id and sm.id = #{storeId} )
                </when>
                <otherwise>
                   AND ut.is_default=1
                </otherwise>
            </choose>
        </where>
    </select>

    <select id="selectUserByRoleKey" resultMap="UserResultMap">
        SELECT u.id,
        u.userid,
        u.name,
        t.tag_name,
        t.shortcodes,
        r.role_name,
        r.role_key,
        r.shop_spec
        FROM `user` u
        LEFT JOIN user_tag ut on ut.user_id = u.id
        LEFT JOIN tag t on t.id = ut.tag_id
        LEFT JOIN store_management sm on sm.tag_id=t.id
        LEFT JOIN user_role ur on ur.user_id = u.id
        LEFT JOIN role r on ur.role_id = r.id
        <where>
            u.status = 1
            <if test="roleKeys !=null">
                <foreach collection="roleKeys" item="roleKey" open="AND r.role_key in (" separator="," close=")">
                    #{roleKey}
                </foreach>
            </if>

            <if test="shopId !=null">
                AND sm.id= #{shopId}
            </if>

            <if test="userIds !=null">
                <foreach collection="userIds" item="userId" open="AND u.id in (" separator="," close=")">
                    #{userId}
                </foreach>
            </if>
        </where>
    </select>

</mapper>
